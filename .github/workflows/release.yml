name: Release

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_INCREMENTAL: 0
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  SCCACHE_GHA_ENABLED: "true"
  RUSTC_WRAPPER: "sccache"

jobs:
  version:
    name: Get Version
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_release: ${{ steps.check.outputs.should_release }}
      sha: ${{ steps.sha.outputs.sha }}
    steps:
      - name: Get commit SHA
        id: sha
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "sha=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "sha=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.sha.outputs.sha }}

      - name: Extract version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected version: $VERSION"

      - name: Check if release exists
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh release view "v${{ steps.version.outputs.version }}" &>/dev/null; then
            echo "should_release=false" >> "$GITHUB_OUTPUT"
            echo "::notice::Release v${{ steps.version.outputs.version }} already exists, skipping release"
          else
            echo "should_release=true" >> "$GITHUB_OUTPUT"
            echo "::notice::Release v${{ steps.version.outputs.version }} will be created"
          fi

  publish:
    name: Publish to crates.io
    if: |
      needs.version.outputs.should_release == 'true' &&
      github.repository == 'dilettante-trading/polyoxide'
    needs: version
    runs-on: ubuntu-latest
    environment: cargo
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.version.outputs.sha }}

      - uses: dtolnay/rust-toolchain@stable

      - name: Login to crates.io
        run: cargo login ${{ secrets.CARGO_REGISTRY_TOKEN }}

      # Publish in dependency order: core -> relay -> gamma -> data -> clob -> polyoxide
      - name: Publish crates to crates.io
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          CRATES=("polyoxide-core" "polyoxide-relay" "polyoxide-gamma" "polyoxide-data" "polyoxide-clob" "polyoxide")

          for crate in "${CRATES[@]}"; do
            PUBLISHED=$(cargo search "$crate" --limit 1 | grep -oP "$crate = \"\K[^\"]+" || echo "0.0.0")
            if [ "$VERSION" = "$PUBLISHED" ]; then
              echo "$crate $VERSION already published, skipping"
              continue
            fi

            echo "Publishing $crate $VERSION (current: $PUBLISHED)"
            for attempt in $(seq 1 6); do
              if cargo publish -p "$crate" --no-verify 2>&1; then
                echo "$crate $VERSION published successfully"
                break
              fi
              if [ "$attempt" -eq 6 ]; then
                echo "::error::Failed to publish $crate after 6 attempts"
                exit 1
              fi
              echo "Attempt $attempt failed, retrying in 5s..."
              sleep 5
            done
          done

  build-cli:
    name: Build CLI (${{ matrix.target }})
    needs: version
    if: needs.version.outputs.should_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-pc-windows-msvc
            os: windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.version.outputs.sha }}

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: "v0.14.0"

      - name: Install cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Configure linker
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          mkdir -p .cargo
          echo '[target.aarch64-unknown-linux-gnu]' >> .cargo/config.toml
          echo 'linker = "aarch64-linux-gnu-gcc"' >> .cargo/config.toml

      - name: Build
        run: cargo build --release --package polyoxide-cli --target ${{ matrix.target }}

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          tar czvf ../../../polyoxide-cli-${{ needs.version.outputs.version }}-${{ matrix.target }}.tar.gz polyoxide

      - name: Package (Windows)
        if: runner.os == 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          7z a ../../../polyoxide-cli-${{ needs.version.outputs.version }}-${{ matrix.target }}.zip polyoxide.exe

      - uses: actions/upload-artifact@v4
        with:
          name: polyoxide-cli-${{ matrix.target }}
          path: polyoxide-cli-${{ needs.version.outputs.version }}-${{ matrix.target }}.*

  release:
    name: Create Release
    needs: [version, publish, build-cli]
    if: needs.version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.version.outputs.sha }}
          fetch-depth: 0

      - name: Create git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ needs.version.outputs.version }}" -m "Release v${{ needs.version.outputs.version }}"
          git push origin "v${{ needs.version.outputs.version }}"

      - name: Generate release notes
        uses: orhun/git-cliff-action@v4
        id: changelog
        with:
          config: cliff.toml
          args: --latest --strip header

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version.outputs.version }}
          name: v${{ needs.version.outputs.version }}
          files: artifacts/*
          body: ${{ steps.changelog.outputs.content }}
