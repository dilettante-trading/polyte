name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected version: $VERSION"

  test:
    name: Test
    needs: version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo test --verbose --workspace

  publish:
    name: Publish to crates.io
    if: github.repository == 'dilettante-trading/polyoxide'
    needs: [version, test]
    runs-on: ubuntu-latest
    environment: cargo
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Login to crates.io
        run: cargo login ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Publish polyoxide-core
        run: |
          cd polyoxide-core
          VERSION=$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)".*/\1/' || echo "")
          if [ -z "$VERSION" ] || [ "$VERSION" = "{" ]; then
            VERSION=$(grep -m1 '^version' ../Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          fi
          PUBLISHED=$(cargo search polyoxide-core --limit 1 | grep -oP 'polyoxide-core = "\K[^"]+' || echo "0.0.0")
          if [ "$VERSION" != "$PUBLISHED" ]; then
            echo "Publishing polyoxide-core $VERSION (current: $PUBLISHED)"
            cargo publish --no-verify
          else
            echo "polyoxide-core $VERSION already published"
          fi

      - name: Publish polyoxide-gamma
        run: |
          cd polyoxide-gamma
          VERSION=$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)".*/\1/' || echo "")
          if [ -z "$VERSION" ] || [ "$VERSION" = "{" ]; then
            VERSION=$(grep -m1 '^version' ../Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          fi
          PUBLISHED=$(cargo search polyoxide-gamma --limit 1 | grep -oP 'polyoxide-gamma = "\K[^"]+' || echo "0.0.0")
          if [ "$VERSION" != "$PUBLISHED" ]; then
            echo "Publishing polyoxide-gamma $VERSION (current: $PUBLISHED)"
            sleep 10
            cargo publish --no-verify
          else
            echo "polyoxide-gamma $VERSION already published"
          fi

      - name: Publish polyoxide-data
        run: |
          cd polyoxide-data
          VERSION=$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)".*/\1/' || echo "")
          if [ -z "$VERSION" ] || [ "$VERSION" = "{" ]; then
            VERSION=$(grep -m1 '^version' ../Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          fi
          PUBLISHED=$(cargo search polyoxide-data --limit 1 | grep -oP 'polyoxide-data = "\K[^"]+' || echo "0.0.0")
          if [ "$VERSION" != "$PUBLISHED" ]; then
            echo "Publishing polyoxide-data $VERSION (current: $PUBLISHED)"
            sleep 10
            cargo publish --no-verify
          else
            echo "polyoxide-data $VERSION already published"
          fi

      - name: Publish polyoxide-clob
        run: |
          cd polyoxide-clob
          VERSION=$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)".*/\1/' || echo "")
          if [ -z "$VERSION" ] || [ "$VERSION" = "{" ]; then
            VERSION=$(grep -m1 '^version' ../Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          fi
          PUBLISHED=$(cargo search polyoxide-clob --limit 1 | grep -oP 'polyoxide-clob = "\K[^"]+' || echo "0.0.0")
          if [ "$VERSION" != "$PUBLISHED" ]; then
            echo "Publishing polyoxide-clob $VERSION (current: $PUBLISHED)"
            sleep 10
            cargo publish --no-verify
          else
            echo "polyoxide-clob $VERSION already published"
          fi

      - name: Publish polyoxide-relay
        run: |
          cd polyoxide-relay
          VERSION=$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)".*/\1/' || echo "")
          if [ -z "$VERSION" ] || [ "$VERSION" = "{" ]; then
            VERSION=$(grep -m1 '^version' ../Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          fi
          PUBLISHED=$(cargo search polyoxide-relay --limit 1 | grep -oP 'polyoxide-relay = "\K[^"]+' || echo "0.0.0")
          if [ "$VERSION" != "$PUBLISHED" ]; then
            echo "Publishing polyoxide-relay $VERSION (current: $PUBLISHED)"
            sleep 10
            cargo publish --no-verify
          else
            echo "polyoxide-relay $VERSION already published"
          fi

      - name: Publish polyoxide
        run: |
          cd polyoxide
          VERSION=$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)".*/\1/' || echo "")
          if [ -z "$VERSION" ] || [ "$VERSION" = "{" ]; then
            VERSION=$(grep -m1 '^version' ../Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          fi
          PUBLISHED=$(cargo search polyoxide --limit 1 | grep -oP 'polyoxide = "\K[^"]+' || echo "0.0.0")
          if [ "$VERSION" != "$PUBLISHED" ]; then
            echo "Publishing polyoxide $VERSION (current: $PUBLISHED)"
            sleep 10
            cargo publish --no-verify
          else
            echo "polyoxide $VERSION already published"
          fi

  build-cli:
    name: Build CLI (${{ matrix.target }})
    needs: [version, test]
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-pc-windows-msvc
            os: windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Configure linker
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          mkdir -p .cargo
          echo '[target.aarch64-unknown-linux-gnu]' >> .cargo/config.toml
          echo 'linker = "aarch64-linux-gnu-gcc"' >> .cargo/config.toml

      - name: Build
        run: cargo build --release --package polyoxide-cli --target ${{ matrix.target }}

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          tar czvf ../../../polyoxide-cli-${{ needs.version.outputs.version }}-${{ matrix.target }}.tar.gz polyoxide

      - name: Package (Windows)
        if: runner.os == 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          7z a ../../../polyoxide-cli-${{ needs.version.outputs.version }}-${{ matrix.target }}.zip polyoxide.exe

      - uses: actions/upload-artifact@v4
        with:
          name: polyoxide-cli-${{ matrix.target }}
          path: polyoxide-cli-${{ needs.version.outputs.version }}-${{ matrix.target }}.*

  release:
    name: Create Release
    needs: [version, publish, build-cli]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Delete existing release if present
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh release view "v$VERSION" &>/dev/null; then
            echo "Deleting existing release v$VERSION"
            gh release delete "v$VERSION" --yes
          fi

      - name: Delete and recreate tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Delete remote tag if exists
          if git ls-remote --tags origin | grep -q "refs/tags/v$VERSION"; then
            echo "Deleting existing tag v$VERSION"
            git push origin --delete "v$VERSION" || true
          fi

          # Delete local tag if exists
          git tag -d "v$VERSION" 2>/dev/null || true

          # Create new tag at current commit
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"

      - name: Generate release notes
        uses: orhun/git-cliff-action@v4
        id: changelog
        with:
          config: cliff.toml
          args: --latest --strip header

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version.outputs.version }}
          name: v${{ needs.version.outputs.version }}
          files: artifacts/*
          body: ${{ steps.changelog.outputs.content }}
